<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>旅行票據記錄器 (相機優化版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
        .form-input, .form-select { background-color: #374151; border-color: #4B5563; color: #F3F4F6; }
        .form-input:focus, .form-select:focus { background-color: #4B5563; border-color: #60A5FA; outline: none; box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.5); }
        .btn { transition: all 0.2s ease-in-out; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); }
        .hidden { display: none; }
        #loading-spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid #3498db; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .status-message { padding: 0.75rem 1rem; border-radius: 0.5rem; margin-top: 1rem; text-align: center; }
        .status-error { background-color: #450a0a; color: #fca5a5; }
        .entry-item { transition: background-color 0.2s; }
        .entry-item:hover { background-color: #374151; }
        #settings-modal { background-color: rgba(0,0,0,0.7); }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 flex items-center justify-center">
    <div class="w-full max-w-2xl mx-auto bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 space-y-6">
        <!-- 標題 -->
        <div class="text-center relative">
            <h1 class="text-3xl font-bold text-white">旅行票據 AI 記錄器</h1>
            <p class="text-gray-400 mt-2">由 Gemini AI 驅動，支援 AI 掃描與手動輸入</p>
            <button id="settings-btn" class="absolute top-0 right-0 p-2 text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            </button>
        </div>

        <!-- 輸入選擇區 -->
        <div id="input-selection-section" class="bg-gray-700 p-6 rounded-xl space-y-4">
            <div>
                <label for="receipt-upload" class="block text-sm font-medium text-gray-300 mb-2">選項一：AI 自動掃描</label>
                <label class="w-full flex items-center justify-center px-4 py-3 bg-blue-600 text-white rounded-lg cursor-pointer hover:bg-blue-700 btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    <span>選擇或拍攝照片</span>
                    <!-- ***** 這裏是唯一的修改 ***** -->
                    <input id="receipt-upload" type="file" class="hidden" accept="image/*" capture="environment">
                </label>
                <p id="file-name" class="text-xs text-gray-400 mt-2 text-center"></p>
            </div>
            <button id="process-btn" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 btn">開始 AI 分析</button>
            <div class="relative flex py-2 items-center"><div class="flex-grow border-t border-gray-600"></div><span class="flex-shrink mx-4 text-gray-400 text-sm">或</span><div class="flex-grow border-t border-gray-600"></div></div>
            <button id="manual-entry-btn" class="w-full bg-gray-600 text-white font-bold py-3 rounded-lg hover:bg-gray-500 btn">選項二：手動輸入單據</button>
            <div id="general-status" class="status-message status-error hidden"></div>
        </div>

        <!-- 處理中動畫 -->
        <div id="loading" class="hidden flex flex-col items-center justify-center space-y-2"><div id="loading-spinner"></div><p id="loading-text" class="text-gray-400">Gemini AI 正在為您分析票據...</p></div>

        <!-- 結果/輸入區 -->
        <div id="result-section" class="hidden space-y-4">
            <h2 id="form-title" class="text-xl font-semibold text-center"></h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block text-sm font-medium text-gray-300">商店名稱</label><input type="text" id="store-name" class="w-full mt-1 p-2 rounded-lg form-input"></div>
                <div>
                    <label for="category" class="block text-sm font-medium text-gray-300">費用類別</label>
                    <select id="category" class="w-full mt-1 p-2 rounded-lg form-select">
                        <option>餐飲 🍜</option><option>交通 🚗</option><option>購物 🛍️</option><option>住宿 🏨</option><option>娛樂 🎟️</option><option>雜項 🧾</option>
                    </select>
                </div>
                <div><label class="block text-sm font-medium text-gray-300">日期</label><input type="date" id="date" class="w-full mt-1 p-2 rounded-lg form-input"></div>
                <div><label class="block text-sm font-medium text-gray-300">時間</label><input type="time" id="time" class="w-full mt-1 p-2 rounded-lg form-input"></div>
                <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-300">購買項目 / 備註</label><textarea id="items" rows="6" class="w-full mt-1 p-2 rounded-lg form-input"></textarea></div>
                <div><label class="block text-sm font-medium text-gray-300">外幣總額</label><div class="flex items-center mt-1"><input type="text" id="currency-symbol" placeholder="JPY" class="w-1/4 p-2 rounded-l-lg form-input uppercase"><input type="number" id="foreign-total" placeholder="3500" class="w-3/4 p-2 rounded-r-lg form-input"></div></div>
                <div><label class="block text-sm font-medium text-gray-300">付款方法</label><input type="text" id="payment-method" class="w-full mt-1 p-2 rounded-lg form-input"></div>
                <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-300">約數 (港幣 HKD)</label><input type="text" id="hkd-total" class="w-full mt-1 p-2 rounded-lg form-input bg-gray-600" readonly></div>
            </div>
            <button id="upload-btn" class="w-full bg-yellow-500 text-gray-900 font-bold py-3 rounded-lg hover:bg-yellow-600 btn">儲存到 Google Sheets</button>
            <div id="upload-status" class="text-center text-sm mt-2"></div>
            <button id="back-btn" class="w-full text-center text-gray-400 hover:text-white mt-2 text-sm">返回</button>
        </div>
        
        <!-- 最近記錄 -->
        <div id="recent-entries-section" class="space-y-3">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-semibold text-white">最近記錄</h3>
                <button id="clear-history-btn" class="text-xs text-red-400 hover:text-red-300">清除全部</button>
            </div>
            <div id="recent-entries-list" class="space-y-2"></div>
        </div>
    </div>

    <!-- 設定 Modal -->
    <div id="settings-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="w-full max-w-md bg-gray-800 rounded-2xl shadow-2xl p-6 space-y-4">
            <h2 class="text-xl font-bold text-white">設定</h2>
            <div>
                <label for="api-key-input" class="block text-sm font-medium text-gray-300 mb-2">Google AI Studio API 金鑰</label>
                <input type="password" id="api-key-input" class="w-full p-2 rounded-lg form-input" placeholder="在這裡貼上你的 API 金鑰">
                <p class="text-xs text-gray-400 mt-1">金鑰只會安全地儲存在你的瀏覽器中。</p>
                <p id="settings-status" class="text-xs text-green-400 mt-2 text-center h-4"></p>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancel-settings-btn" class="px-4 py-2 bg-gray-600 rounded-lg hover:bg-gray-500 btn">關閉</button>
                <button id="save-settings-btn" class="px-4 py-2 bg-blue-600 rounded-lg hover:bg-blue-500 btn">儲存</button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const apiKeyInput = document.getElementById('api-key-input');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const cancelSettingsBtn = document.getElementById('cancel-settings-btn');
        const inputSelectionSection = document.getElementById('input-selection-section');
        const processBtn = document.getElementById('process-btn');
        const manualEntryBtn = document.getElementById('manual-entry-btn');
        const backBtn = document.getElementById('back-btn');
        const loading = document.getElementById('loading');
        const resultSection = document.getElementById('result-section');
        const receiptUpload = document.getElementById('receipt-upload');
        const fileNameDisplay = document.getElementById('file-name');
        const generalStatus = document.getElementById('general-status');
        const formTitle = document.getElementById('form-title');
        const uploadBtn = document.getElementById('upload-btn');
        const uploadStatus = document.getElementById('upload-status');
        const recentEntriesSection = document.getElementById('recent-entries-section');
        const recentEntriesList = document.getElementById('recent-entries-list');
        const clearHistoryBtn = document.getElementById('clear-history-btn');

        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbygMu4YZ3r9E2m9CVyp3NNk4lGdhMaBCn04OQ8FP_fJWG_PfE_E7hE-ETY8lMXUKRWk6g/exec";

        // Event Listeners
        window.addEventListener('load', () => {
            loadRecentEntries();
            apiKeyInput.value = localStorage.getItem('geminiApiKey') || '';
        });
        settingsBtn.addEventListener('click', () => settingsModal.classList.remove('hidden'));
        cancelSettingsBtn.addEventListener('click', () => settingsModal.classList.add('hidden'));
        saveSettingsBtn.addEventListener('click', () => {
            localStorage.setItem('geminiApiKey', apiKeyInput.value);
            const statusEl = document.getElementById('settings-status');
            statusEl.textContent = 'API 金鑰已儲存！';
            setTimeout(() => {
                settingsModal.classList.add('hidden');
                statusEl.textContent = ''; 
            }, 1500);
        });
        receiptUpload.addEventListener('change', () => { fileNameDisplay.textContent = receiptUpload.files.length > 0 ? `已選擇檔案: ${receiptUpload.files[0].name}` : ''; });
        processBtn.addEventListener('click', handleAIProcess);
        manualEntryBtn.addEventListener('click', handleManualEntry);
        backBtn.addEventListener('click', goBack);
        uploadBtn.addEventListener('click', handleUpload);
        clearHistoryBtn.addEventListener('click', clearHistory);
        document.getElementById('foreign-total').addEventListener('input', updateHkdAmount);
        document.getElementById('currency-symbol').addEventListener('input', updateHkdAmount);

        // Functions
        async function handleAIProcess() {
            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) {
                showError('請先點擊右上角的設定按鈕，輸入你的 Google AI Studio API 金鑰。');
                return;
            }
            const imageFile = receiptUpload.files[0];
            if (!imageFile) { showError('請先上傳一張票據照片。'); return; }
            hideError();
            showView('loading');
            try {
                const base64ImageData = await fileToBase64(imageFile);
                const result = await analyzeReceiptWithGemini(base64ImageData, apiKey);
                formTitle.textContent = "AI 分析結果 (請核對)";
                populateForm(result);
                await updateHkdAmount(); 
                showView('result');
            } catch (error) {
                console.error('AI 分析流程出錯:', error);
                showError(error.message || 'AI 分析失敗，請檢查你的 API 金鑰是否正確。');
                showView('input');
            }
        }

        function handleManualEntry() {
            hideError();
            formTitle.textContent = "手動輸入一筆新紀錄";
            clearForm();
            document.getElementById('date').valueAsDate = new Date();
            showView('result');
        }

        async function handleUpload() {
            const dataToUpload = {
                date: document.getElementById('date').value, time: document.getElementById('time').value,
                storeName: document.getElementById('store-name').value, paymentMethod: document.getElementById('payment-method').value,
                category: document.getElementById('category').value, items: document.getElementById('items').value,
                foreignTotal: document.getElementById('foreign-total').value, currency: document.getElementById('currency-symbol').value.toUpperCase(),
                hkdTotal: document.getElementById('hkd-total').value,
            };

            if (!dataToUpload.storeName || !dataToUpload.foreignTotal) {
                uploadStatus.innerHTML = `<span class="text-red-400">請填寫商店名稱和總額。</span>`; return;
            }

            uploadBtn.disabled = true;
            uploadBtn.textContent = '上傳中...';
            uploadStatus.innerHTML = `<span class="text-gray-400">正在儲存到 Google Sheets...</span>`;

            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST', mode: 'no-cors', body: JSON.stringify(dataToUpload),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                });
                uploadStatus.innerHTML = `<span class="text-green-400">✔ 儲存成功！</span>`;
                addEntryToRecentList(dataToUpload);
                setTimeout(goBack, 1500);
            } catch (error) {
                console.error('上傳失敗:', error);
                uploadStatus.innerHTML = `<span class="text-red-400">✖ 上傳失敗，請檢查 Apps Script 部署設定。</span>`;
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = '儲存到 Google Sheets';
            }
        }

        function addEntryToRecentList(data) {
            const entryDiv = document.createElement('div');
            entryDiv.className = 'bg-gray-700 p-3 rounded-lg flex justify-between items-center entry-item';
            entryDiv.innerHTML = `
                <div>
                    <p class="font-semibold">${data.storeName || '無標題'}</p>
                    <p class="text-xs text-gray-400">${data.date} - ${data.category}</p>
                </div>
                <p class="font-semibold text-lg">${data.currency} ${data.foreignTotal}</p>
            `;
            recentEntriesList.prepend(entryDiv);
            saveRecentEntries();
        }

        function saveRecentEntries() {
            const entries = [];
            document.querySelectorAll('#recent-entries-list .entry-item').forEach(item => {
                entries.push({
                    storeName: item.querySelector('p:first-child').textContent,
                    details: item.querySelector('.text-xs').textContent,
                    amount: item.querySelector('.text-lg').textContent,
                });
            });
            localStorage.setItem('travelEntries', JSON.stringify(entries.slice(0, 20)));
        }

        function loadRecentEntries() {
            const entries = JSON.parse(localStorage.getItem('travelEntries') || '[]');
            recentEntriesList.innerHTML = '';
            entries.forEach(data => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'bg-gray-700 p-3 rounded-lg flex justify-between items-center entry-item';
                entryDiv.innerHTML = `
                    <div>
                        <p class="font-semibold">${data.storeName}</p>
                        <p class="text-xs text-gray-400">${data.details}</p>
                    </div>
                    <p class="font-semibold text-lg">${data.amount}</p>
                `;
                recentEntriesList.appendChild(entryDiv);
            });
        }
        
        function clearHistory() {
            // Replaced confirm() with a non-blocking approach if needed, but for this simple case it's fine.
            if (window.confirm('確定要清除所有本地記錄嗎？(Google Sheet 上的資料不會被刪除)')) {
                localStorage.removeItem('travelEntries');
                loadRecentEntries();
            }
        }

        function showView(view) {
            loading.classList.add('hidden');
            inputSelectionSection.classList.add('hidden');
            resultSection.classList.add('hidden');
            recentEntriesSection.classList.add('hidden');

            if (view === 'loading') {
                loading.classList.remove('hidden');
            } else if (view === 'result') {
                resultSection.classList.remove('hidden');
            } else { // 'input' view
                inputSelectionSection.classList.remove('hidden');
                recentEntriesSection.classList.remove('hidden');
            }
        }

        function goBack() {
            clearForm();
            showView('input');
        }

        function clearForm() {
            const form = resultSection.querySelector('.grid');
            if (form) {
                form.querySelectorAll('input, textarea, select').forEach(el => el.value = '');
            }
            fileNameDisplay.textContent = '';
            receiptUpload.value = '';
            uploadStatus.innerHTML = '';
        }
        
        async function analyzeReceiptWithGemini(base64ImageData, apiKey) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const prompt = `Analyze this receipt image. Extract: storeName, transactionDate (YYYY-MM-DD), transactionTime (HH:MM), totalAmount (number), currency (3-letter ISO code), paymentMethod ("Credit Card", "Cash", etc.), and items (array of strings). Return clean JSON. Use null for missing fields.`;
            const payload = {
                contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64ImageData }}]}],
                generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { "storeName": { "type": "STRING" }, "transactionDate": { "type": "STRING" }, "transactionTime": { "type": "STRING" }, "totalAmount": { "type": "NUMBER" }, "currency": { "type": "STRING" }, "paymentMethod": { "type": "STRING" }, "items": { "type": "ARRAY", "items": { "type": "STRING" } } } } }
            };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) { const errorBody = await response.json(); throw new Error(`AI 伺服器錯誤: ${errorBody.error?.message || response.statusText}`); }
            const result = await response.json();
            if (result.candidates?.[0]?.content?.parts?.[0]) { return JSON.parse(result.candidates[0].content.parts[0].text); } 
            else { throw new Error("AI 未能返回有效的分析結果。"); }
        }

        function populateForm(data) {
            document.getElementById('store-name').value = data.storeName || '';
            document.getElementById('payment-method').value = data.paymentMethod || '';
            document.getElementById('date').value = data.transactionDate || '';
            document.getElementById('time').value = data.transactionTime || '';
            document.getElementById('items').value = data.items ? data.items.join('\n') : '';
            document.getElementById('currency-symbol').value = data.currency || '';
            document.getElementById('foreign-total').value = data.totalAmount || '';
        }

        async function updateHkdAmount() {
            const foreignTotal = parseFloat(document.getElementById('foreign-total').value);
            const currency = document.getElementById('currency-symbol').value.trim().toUpperCase();
            const hkdTotalInput = document.getElementById('hkd-total');
            if (!foreignTotal || !currency || currency.length < 3) { hkdTotalInput.value = ''; return; }
            hkdTotalInput.value = '查詢中...';
            try {
                const response = await fetch(`https://api.exchangerate-api.com/v4/latest/${currency}`);
                if (!response.ok) throw new Error('無法獲取匯率');
                const data = await response.json();
                const rate = data.rates.HKD;
                if (rate) {
                    const hkdAmount = (foreignTotal * rate).toFixed(2);
                    hkdTotalInput.value = `約 HKD ${hkdAmount} (匯率 ~${rate.toFixed(4)})`;
                } else { hkdTotalInput.value = '找不到對港幣匯率'; }
            } catch (error) { console.error(error); hkdTotalInput.value = '匯率查詢失敗'; }
        }
        
        function fileToBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result.split(',')[1]); reader.onerror = error => reject(error); }); }
        function showError(message) { generalStatus.textContent = message; generalStatus.classList.remove('hidden'); }
        function hideError() { generalStatus.classList.add('hidden'); }
    </script>
</body>
</html>
